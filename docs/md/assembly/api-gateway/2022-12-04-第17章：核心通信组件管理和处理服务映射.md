---
title: 第17章：核心通信组件管理和处理服务映射
pay: https://articles.zsxq.com/id_r00wui6wm1fw.html
---

# 第17章：核心通信组件管理和处理服务映射

作者：小傅哥
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

>沉淀、分享、成长，让自己和他人都能有所收获！😄

- **本章难度**：★★★☆☆
- **本章重点**：引入通信 api-gateway-core 到 api-gateway-assist 中进行创建和使用，并拉取自注册中心的映射信息注册到本地的网关通信组件中。
- **课程视频**：[https://t.zsxq.com/080SvY1Gg](https://t.zsxq.com/080SvY1Gg)


## 一、学习指引

`为什么你搭建不出那些优秀的架构？`

MVC 是我们通常的业务类开发架构，但当你逐步的接触到一些源码时，会发现这些源码并不是 MVC 架构，甚至很多时候这些分层会感觉很陌生。但要去分析梳理又发现，这些分层结构真的做的很优秀。

可为什么让你开发一个通用的技术类项目的时候，你脑袋里并没有这样的思维结构呢。总感觉自己要下手写代码就是创建一个 service 包，之后不断地累加逻辑。这是因为吸收优秀框架源码的架构太少了，脑袋里的印象只有MVC，自己的编程开发视野根本没打开，所以才没有可以模仿的分层结构。

所以为了提升这方面的技能，一定要多学习不同类型的源码架构并不断的运用和实践，才能提升你的能力。

## 二、组件管理

第17章是在第15章的基础上继续完善服务发现的相关功能，把从注册中心拉取的网关映射信息【系统、接口、方法】映射到本地通信组件中。这样就算完成了注册中心到本地服务的一个打通处理，映射完成后就可以通过HTTP请求到网关通信层，完成对RPC的泛化调用。

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-01.png?raw=true" width="500px">
</div>

- 首先在实现中要引入 api-gateway-core-09【本章止最新版本】到 api-gateway-assist 中，通过 GatewayAutoConfig 配置类对网关通信组件进行 Bean 对象的创建和启动。
- 之后就可以在 GatewayApplication 中处理从网关注册中心拉取到的接口信息进行注册操作。也就是把接口向 api-gateway-core 完成注册映射操作。**可参考 api-gateway-core-09 ApiTest 测试类**

## 三、功能实现

### 1. 工程结构

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-02.png?raw=true" width="500px">
</div>

- 源码：[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-assist/-/tree/master/api-gateway-assist-03](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-assist/-/tree/master/api-gateway-assist-03) —— 申请访问权限(加入仓库)：[https://t.zsxq.com/04VB66uzz](https://t.zsxq.com/04VB66uzz)

### 2. 引入服务

```xml
<!-- 引入网关通信组件 -->
<dependency>
    <groupId>cn.bugstack.gateway</groupId>
    <artifactId>api-gateway-core-09</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

- 在 api-gateway-core-09 中进行 install 打包，之后引入到 api-gateway-assist-03 中进行使用。

另外这里还有一个配置是让 api-gateway-core-09 可以打包到 api-gateway-assist 中的配置。如下；

```xml
<configuration>
    <artifactSet>
        <includes>
            <include>cn.bugstack.gateway:api-gateway-core-09:jar:</include>
        </includes>
    </artifactSet>
</configuration>
```

- 这个操作主要是因为将来把 api-gateway-assist 给外部使用时，不用在额外引用 api-gateway-core 了。

### 3. 服务创建

**源码详见**：`cn.bugstack.gateway.assist.config.GatewayAutoConfig`

```java
@Bean
public cn.bugstack.gateway.core.session.Configuration gatewayCoreConfiguration(GatewayServiceProperties properties) {
    cn.bugstack.gateway.core.session.Configuration configuration = new cn.bugstack.gateway.core.session.Configuration();
    String[] split = properties.getAddress().split(":");
    configuration.setHostName(split[0].trim());
    configuration.setPort(Integer.parseInt(split[1].trim()));
    return configuration;
}

@Bean
public Channel initGateway(cn.bugstack.gateway.core.session.Configuration configuration) throws ExecutionException, InterruptedException {
    // 1. 基于配置构建会话工厂
    DefaultGatewaySessionFactory gatewaySessionFactory = new DefaultGatewaySessionFactory(configuration);
    // 2. 创建启动网关网络服务
    GatewaySocketServer server = new GatewaySocketServer(configuration, gatewaySessionFactory);
    Future<Channel> future = Executors.newFixedThreadPool(2).submit(server);
    Channel channel = future.get();
    if (null == channel) throw new RuntimeException("api gateway core netty server start error channel is null");
    while (!channel.isActive()) {
        logger.info("api gateway core netty server gateway start Ing ...");
        Thread.sleep(500);
    }
    logger.info("api gateway core netty server gateway start Done! {}", channel.localAddress());
    return channel;
}
```

- 在 GatewayAutoConfig 自动创建 Bean 对象类中，创建 **cn.bugstack.gateway.core.session.Configuration** 配置，以及启动网关服务。启动后就可以接收服务接口的注册操作了。

### 4. 注册接口

**源码详见**：`cn.bugstack.gateway.assist.application.GatewayApplication`

```java
@Override
public void onApplicationEvent(ContextRefreshedEvent event) {
    // 1. 注册网关服务；每一个用于转换 HTTP 协议泛化调用到 RPC 接口的网关都是一个算力，这些算力需要注册网关配置中心
    gatewayCenterService.doRegister(properties.getAddress(),
            properties.getGroupId(),
            properties.getGatewayId(),
            properties.getGatewayName(),
            properties.getGatewayAddress());
    
    // 2. 拉取网关配置；每个网关算力都会在注册中心分配上需要映射的RPC服务信息，包括；系统、接口、方法
    ApplicationSystemRichInfo applicationSystemRichInfo = gatewayCenterService.pullApplicationSystemRichInfo(properties.getAddress(), properties.getGatewayId());
    List<ApplicationSystemVO> applicationSystemVOList = applicationSystemRichInfo.getApplicationSystemVOList();
    for (ApplicationSystemVO system : applicationSystemVOList) {
        List<ApplicationInterfaceVO> interfaceList = system.getInterfaceList();
        for (ApplicationInterfaceVO itf : interfaceList) {
            // 2.1 创建配置信息加载注册
            configuration.registryConfig(system.getSystemId(), system.getSystemRegistry(), itf.getInterfaceId(), itf.getInterfaceVersion());
            List<ApplicationInterfaceMethodVO> methodList = itf.getMethodList();
            // 2.2 注册系统服务接口信息
            for (ApplicationInterfaceMethodVO method : methodList) {
                HttpStatement httpStatement = new HttpStatement(
                        system.getSystemId(),
                        itf.getInterfaceId(),
                        method.getMethodId(),
                        method.getParameterType(),
                        method.getUri(),
                        HttpCommandType.valueOf(method.getHttpCommandType()),
                        method.isAuth());
                configuration.addMapper(httpStatement);
                logger.info("网关服务注册映射 系统：{} 接口：{} 方法：{}", system.getSystemId(), itf.getInterfaceId(), method.getMethodId());
            }
        }
    }
}
```

- onApplicationEvent 方法中的第2步，就是从注册中心获取的属于当前网关需要完成映射操作的系统信息。包括这个系统的接口和方法。通过循环遍历查询到的信息进行注册处理。
- 在这里大家也可以提前思考🤔下，如果网关服务已经启动后，新增的接口怎么添加到注册里。

## 四、测试验证

### 1. 前置条件

1. 你需要先对 api-gateway-core-09 进行构建，否则 api-gateway-assist-03 会缺失包报错。
2. 启动 Docker 和 ZK，也就是 Dubbo 的注册中心。
3. 在2的步骤上，启动 api-gateway-test-provider 观察日志，确保 RPC 服务启动成功。
4. 启动 api-gateway-center 注册中心，这样 api-gateway-assist-03 才能从注册中心拉取接口。
5. 修改 api-gateway-assist-00 pom 引入 api-gateway-assist-03
6. 使用 api-gateway-core-09 的 ShiroTest 生成 token 用于测试接口：[http://localhost:7397/wg/activity/insert](http://localhost:7397/wg/activity/insert)  所需的参数
7. **这里我预留了一个小bug，如果你不能发现，那么将不能测试到正确的结果。**

### 2. 网关助手

启动工程：api-gateway-assist-00 确保 pom 引入的是最新的 api-gateway-assist-03 

```java
2022-12-03 18:48:52.356  INFO 42011 --- [*cketServer    : socket server start done.
2022-12-03 18:48:52.356  INFO 42011 --- [*AutoConfig    : api gateway core netty server gateway start Done! /127.0.0.1:7397
2022-12-03 18:48:52.475  INFO 42011 --- [*catWebServer  : Tomcat started on port(s): 8002 (http) with context path ''
2022-12-03 18:48:52.765  INFO 42011 --- [*nterService   : 向网关中心注册网关算力服务 gatewayId：api-gateway-g4 gatewayName：电商配送网关 gatewayAddress：127.0.0.1:7397 注册结果：{"code":"0000","info":"成功","data":true}
2022-12-03 18:48:52.806  INFO 42011 --- [*nterService   : 从网关中心拉取应用服务和接口的配置信息到本地完成注册。gatewayId：api-gateway-g4
log4j:WARN No appenders could be found fo*gerFactory).
log4j:WARN Please initialize the log4j sy*
log4j:WARN See http://logging.apache.org/*
2022-12-03 18:48:52.994  INFO 42011 --- [*Application   : 网关服务注册映射 系统：api-gateway-test 接口：cn.bugstack.gateway.rpc.IActivityBooth 方法：insert
2022-12-03 18:48:52.994  INFO 42011 --- [*Application   : 网关服务注册映射 系统：api-gateway-test 接口：cn.bugstack.gateway.rpc.IActivityBooth 方法：sayHi
2022-12-03 18:48:52.997  INFO 42011 --- [*Application   : Started Application in 3.211 seconds (JVM running for 3.75)
```

- 启动的过程包括启动网关服务，注册网关信息，拉取接口映射配置等操作。
- 接下来我们访问下网关提供的接口信息。

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-17-03.png?raw=true" width="700px">
</div>

- 访问接口：[http://localhost:7397/wg/activity/insert](http://localhost:7397/wg/activity/insert) - 记得生成 Token 你之前的可能已经过期了。

## 五、本章小结

- 本章内容主要在网关助手中扩展了对服务的创建、启动和注册操作。在这样的一个类中完成了注册中心、通信服务、接口调用等内容的链接处理。
- 其实这就是网关最核心的主干流程的内容，只要你把到这章节的内容搞清楚，基本就清楚了网关是如何工作的`1/2`核心内容。
- 路还很长，我们一起刚刚看到了一些照进来的曙光，一起加油！

## 六、常见问题

**预留；这里汇总读者在学习本章中遇到的共性问题，解答后存放到这里供大家参考**

## 七、用户作业

**预留；这里汇总读者在学习结束后提交的课程作业，大家可以互相分享一起来学习**
