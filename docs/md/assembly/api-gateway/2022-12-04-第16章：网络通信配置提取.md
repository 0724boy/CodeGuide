---
title: 第16章：网络通信配置提取
pay: https://articles.zsxq.com/id_j0o8mnm7up5j.html
---

# 第16章：网络通信配置提取

作者：小傅哥
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

>沉淀、分享、成长，让自己和他人都能有所收获！😄

- **本章难度**：★★☆☆☆
- **本章重点**：提取 Netty 通信服务配置信息，包括：IP、端口、线程等，到会话的 Configuration 配置类中进行统一的维护和管理，便于外部调用方向内部传递信息。
- **课程视频**：[https://t.zsxq.com/080SvY1Gg](https://t.zsxq.com/080SvY1Gg)

## 一、学习指引

`技能 + 思想 + 熟练 = 牛逼的研发！`

当我看到越来越多的程序员👨🏻‍💻转向架构师以后，开始逐步脱离编程开发。**我知道，他完了。** 一个PPT架构师是不能给出符合真实场景的优秀设计的，当你脱离细节以后你所给出的内容都是只是自我主观判断下的思想层面内容。但这份没有经过自己落地的思想，其实怎么表达都是虚的，因为编程中那些琐碎的细节才是真正的问题所在。

## 二、配置提取

对于第16章内容的处理，主要来自于在第17章开发的 api-gateway-assist-03 网关通信助手组件，对于网关通信服务的启动，可以指定配置下 Netty 服务的IP地址和端口信息。

目前这部分配置在 api-gateway-core-08 中是写死在 GatewaySocketServer 类中的，所以要对这部分内容进行处理。此外由于我们需要对 api-gateway-core 进行组件打包 Jar 给 api-gateway-assist 引入使用，那么还需要优化下 POM 配置，避免每次打包都做对 test 进行操作（这部分读者可以验证打包日志输出内容 install 打包）。

这里还有一个细节点，api-gateway-assist 引入 api-gateway-core 以后，如果希望把这个 Jar 包就打入到 api-gateway-assist 中。那么 api-gateway-core 的包结构最好是有一个区分的。但目前是 **cn.bugstack.gateway** 之后就是各个分层功能了，所以我们调整为 **cn.bugstack.gateway.core** 的结构来处理。

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-01.png?raw=true" width="500px">
</div>

- 如图所示，修改分层结构。之后对 socket 通信提取配置，放到 session 会话的 Configuration 类中维护即可。

## 三、功能实现

### 1. 工程结构

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-02.png?raw=true" width="500px">
</div>

- 源码：[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-core/-/tree/master/api-gateway-core-09](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-core/-/tree/master/api-gateway-core-09) —— 申请访问权限(加入仓库)：[https://t.zsxq.com/04VB66uzz](https://t.zsxq.com/04VB66uzz)
- 在工程中新添加一个 core 包，把代码迁移过去就可以了。

### 2. 提取配置

这里我们要把 ewaySocketServer 类中的一些配置信息，包括；服务启动IP、服务端口、线程数，进行提取。

**源码详见**：`cn.bugstack.gateway.core.socket.GatewaySocketServer`

<div align="center">
    <img src="https://bugstack.cn/images/article/assembly/api-gateway/api-gateway-16-03.png?raw=true" width="800px">
</div>

配置内容提取后，就是放到 Configuration 中进行统一维护。这里不要再增加其他的配置文件或者说通过构造入参的方式进行处理，因为这样你会失去对一个配置的统一管理。

**源码详见**：`cn.bugstack.gateway.core.session.Configuration`

```java
public class Configuration {

    // 网关 Netty 服务地址
    private String hostName = "127.0.0.1";
    // 网关 Netty 服务端口
    private int port = 7397;
    // 网关 Netty 服务线程数配置
    private int bossNThreads = 1;
    private int workNThreads = 4;
    
    // ... 省略部分代码
}    
```

- 在 Configuration 类中统一维护网关的一些配置信息。

### 3. 禁止打包测试内容

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <configuration>
        <skipTests>true</skipTests>
    </configuration>
</plugin>
```

- 这里其实就是一个配置问题，避免我们打包的时候把 test 单测内容启动喽。

## 四、功能测试

### 1. 前置条件

本章节涉及了 RPC 服务的使用，所以需要把 RPC 测试工程下载到启动；
- 地址：[https://gitcode.net/KnowledgePlanet/gateway/api-gateway-test-provider](https://gitcode.net/KnowledgePlanet/gateway/api-gateway-test-provider)
- 配置：zookeeper 3.4.13 —— 必须有注册中心，且你的 zookeeper 版本要与工程的 POM 中配置的 zookeeper 匹配，否则会启动失败
- 操作：测试前先确保 api-gateway-test-provider 启动完成
- 这部分内容已经在 api-gateway-core 中讲解过，可以对照学习。

### 2. 单元测试

```java
@Test
public void test_gateway() throws InterruptedException, ExecutionException {
    // 1. 创建配置信息加载注册
    Configuration configuration = new Configuration();
    configuration.setHostName("127.0.0.1");
    configuration.setPort(7397);
    // 2. 基于配置构建会话工厂
    DefaultGatewaySessionFactory gatewaySessionFactory = new DefaultGatewaySessionFactory(configuration);
    // 3. 创建启动网关网络服务
    GatewaySocketServer server = new GatewaySocketServer(configuration, gatewaySessionFactory);
    Future<Channel> future = Executors.newFixedThreadPool(2).submit(server);
    Channel channel = future.get();
    if (null == channel) throw new RuntimeException("netty server start error channel is null");
    while (!channel.isActive()) {
        logger.info("netty server gateway start Ing ...");
        Thread.sleep(500);
    }
    logger.info("netty server gateway start Done! {}", channel.localAddress());
    // 4. 注册接口
    configuration.registryConfig("api-gateway-test", "zookeeper://127.0.0.1:2181", "cn.bugstack.gateway.rpc.IActivityBooth", "1.0.0");
    HttpStatement httpStatement01 = new HttpStatement(
            "api-gateway-test",
            "cn.bugstack.gateway.rpc.IActivityBooth",
            "sayHi",
            "java.lang.String",
            "/wg/activity/sayHi",
            HttpCommandType.GET,
            false);
    HttpStatement httpStatement02 = new HttpStatement(
            "api-gateway-test",
            "cn.bugstack.gateway.rpc.IActivityBooth",
            "insert",
            "cn.bugstack.gateway.rpc.dto.XReq",
            "/wg/activity/insert",
            HttpCommandType.POST,
            true);
    configuration.addMapper(httpStatement01);
    configuration.addMapper(httpStatement02);
    Thread.sleep(Long.MAX_VALUE);
}
```

- 小傅哥这里有意把注册接口映射的动作放到服务启动之后，其实映射你可以放到任何时候。也就是说我们的网关通信组件启动完成前后你都可以添加映射接口，也就是当有新的接口注册上来以后，也可以随时映射到网关中。
- 好啦，其余内容就一致了，这里就不做过多的演示了。你只要确保你的代码调整是可以顺利测试的即可。

## 五、本章小结

- 本章都是为了满足下一个章节所做的完善补充，这些补充其实都是留出一些扩展的口子给外部去操作。
- 类似的场景后续我们还需要留出类似 MyBatis 框架中对外的插件服务，这样可以让外部做更多的扩展处理。

## 六、常见问题

**预留；这里汇总读者在学习本章中遇到的共性问题，解答后存放到这里供大家参考**

## 七、用户作业

**预留；这里汇总读者在学习结束后提交的课程作业，大家可以互相分享一起来学习**



